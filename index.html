<!DOCTYPE html>
  <html>
  <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <title>Phaser-pong</title>
      <link rel="stylesheet" href="">
      <script type="text/javascript" src="bower_components/phaser/build/phaser.js"></script>
      <script type="text/javascript">
				var FIELD_WIDTH = 480;
				var FIELD_HEIGHT = 640;

        var BALL_SPEED = 300;

				var PLAYER1_POSITION = FIELD_HEIGHT - 16;
				var PLAYER2_POSITION = 16;
				var PLAYER_SPEED = 6;

        var game = new Phaser.Game(FIELD_WIDTH, FIELD_HEIGHT, Phaser.CANVAS, '', { preload: preload, create: create, update: update});
        var player1, player2, ball;
        var ballReleased = false;
				var startKey;
				var player1KeyLeft, player1KeyRight;
				var player2KeyLeft, player2KeyRight;

        function preload () {
          game.load.image('player1', 'assets/player1.png');
					game.load.image('player2', 'assets/player2.png');
          game.load.image('ball', 'assets/ball.png');
          game.load.image('background', 'assets/starfield.png');
        }
        function create () {
					game.physics.startSystem(Phaser.Physics.ARCADE);
          game.add.tileSprite(0,0,FIELD_WIDTH, FIELD_HEIGHT, 'background');
          player1 = createPlayer(game.world.centerX, PLAYER1_POSITION, 'player1', Phaser.Keyboard.LEFT, Phaser.Keyboard.RIGHT);
          player2 = createPlayer(game.world.centerX, PLAYER2_POSITION, 'player2', Phaser.Keyboard.A, Phaser.Keyboard.D);
          ball = createBall(game.world.centerX, game.world.centerY);

					startKey = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);
					startKey.onDown.add(setBall, this);
        }
        function update () {
          processBallAndPlayerCollisions();
          checkGoal();
        }

        function createPlayer(x, y, skin, keyLeft, keyRight) {
          var player = game.add.sprite(x,y, skin);
					game.physics.enable(player, Phaser.Physics.ARCADE);
          player.anchor.setTo(0.5,0.5);
					player.enableBody = true;
          player.body.collideWorldBounds = true;
          player.body.bounce.setTo(1,1);
          player.body.immovable = true;

					game.input.keyboard.addKey(keyLeft).onHoldCallback = function() {
						movePlayer(player, -PLAYER_SPEED);
					};
					game.input.keyboard.addKey(keyRight).onHoldCallback = function() {
						movePlayer(player, PLAYER_SPEED);
					};

          return player;
        }
        function createBall (x,y) {
          var tmpBall = game.add.sprite(x,y, 'ball');
					game.physics.enable(tmpBall, Phaser.Physics.ARCADE);
          tmpBall.anchor.setTo(0.5,0.5);
          tmpBall.body.collideWorldBounds = true;
          tmpBall.body.bounce.setTo(1, 1);
          return tmpBall;
        }
        function setBall () {
          if (ballReleased) {
            ball.x = game.world.centerX;
            ball.y = game.world.centerY;
            ball.body.velocity.x = 0;
            ball.body.velocity.y = 0;
            ballReleased = false;
          } else {
            ball.body.velocity.x = BALL_SPEED;
            ball.body.velocity.y = -BALL_SPEED;
            ballReleased = true;
          }
        }

        function processBallAndPlayerCollisions () {
          game.physics.arcade.collide(ball, player1, ballHitsPlayer, null, this);
          game.physics.arcade.collide(ball, player2, ballHitsPlayer, null, this);
        }

        function ballHitsPlayer (ball, player) {
          var diff = 0;

          if (ball.x < player.x) {
            diff = player.x - ball.x;
          } else if (ball.x > player.x) {
            diff = ball.x - player.x;
            ball.body.velocity.x = (10*diff);
          } else {
            ball.body.velocity.x = 2 + Math.random() * 8;
          }
        }
        function checkGoal () {
          if (ball.y < ball.height) {
            setBall();
          } else if (ball.y > FIELD_HEIGHT - ball.height) {
            setBall();
          }
        }

        function movePlayer(player, step) {
					var playerHalfWidth = player.width / 2;
          player.x = player.x + step;
          if (player.x < playerHalfWidth) {
            player.x = playerHalfWidth;
          } else if (player.x > game.width - playerHalfWidth) {
            player.x = game.width - playerHalfWidth;
          }
        }
      </script>
  </head>
  <body>

  </body>
</html>
